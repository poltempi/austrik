---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { fetchCategories, fetchPostsByCategoryId, fetchPostsByCategoryName } from "../../services/posts";

const { name } = Astro.params;
if (!name) {
  return Astro.redirect('/', 302);
}

Astro.response.headers.set('Cache-Control', 'no-store, max-age=0');

const categories = await fetchCategories();
const category = categories.find((c) => c.name.toLowerCase() === String(name).toLowerCase()) ?? null;
if (!category) {
  return new Response('Not Found', { status: 404 });
}
let posts = await fetchPostsByCategoryId(category.id);
if (!posts || posts.length === 0) {
  posts = await fetchPostsByCategoryName(category.name);
}
---

<BaseLayout title={`${category.name} · Austrik`} description={category.description}>
  <h1 style="margin-top:0">{category.name}</h1>
  <p style="color:#4b5563; margin-top:.25rem;">{category.description}</p>

  {posts.length === 0 ? (
    <p>No hay publicaciones aún en esta categoría.</p>
  ) : (
    <div class="post-grid" style="margin-top:1rem;">
      {posts.map((p) => (
        <a class="post-card" href={`/${p.slug}`}>
          <figure>
            <img src={p.cover_image_url ?? '/demo-cover.svg'} alt={p.title} loading="lazy" onerror="this.onerror=null;this.src='/demo-cover.svg'" />
            <div class="caption">
              <span class="badge">{category.name}</span>
              <h2 class="title">{p.title}</h2>
              {p.published_at && <small class="meta">{new Date(p.published_at).toLocaleDateString('es')}</small>}
            </div>
          </figure>
        </a>
      ))}
    </div>
  )}
</BaseLayout>


